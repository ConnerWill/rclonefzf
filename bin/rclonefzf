#!/usr/bin/env bash
#vim:filetype=sh:shiftwidth=2:softtabstop=2:expandtab:foldmethod=marker:foldmarker=###{{{,###}}}
#shellcheck disable=2016,2034,2059,2120,2154,2249,2310,2312

set -Eeo pipefail
IFS=$'\n\t'

#######################################
# Script metadata
#######################################
readonly SCRIPT_NAME="${0##*/}"
readonly SCRIPT_AUTHOR="ConnerWill"
readonly SCRIPT_AUTHOR_URL="https://github.com/ConnerWill"
readonly SCRIPT_DESCRIPTION="Interactive terminal UI for browsing and viewing files on rclone remotes using fzf"
readonly VERSION="1.0.18"

#######################################
# Config locations (precedence order)
#######################################
readonly XDG_CONFIG_DIR="${XDG_CONFIG_HOME:-${HOME}/.config}/rclonefzf"
readonly CONFIG_PATHS=(
  "${XDG_CONFIG_DIR}/rclonefzf.conf"
  "${HOME}/.rclonefzf.conf"
)

#######################################
# Defaults (override via config)
#######################################
THEME="${THEME:-default}"
PREVIEW_WINDOW="${PREVIEW_WINDOW:-right:60%:wrap}"
LAYOUT="${LAYOUT:-reverse}"
BORDER="${BORDER:-rounded}"
ENABLE_PREVIEW=true
VERBOSE=${VERBOSE:-false}
CTRL_C_CLOSE=${CTRL_C_CLOSE:-true}
RCLONEFZF_PAGER="${PAGER:-less}"
RCLONE_MAX_DEPTH=${RCLONE_MAX_DEPTH:-10}
RCLONEFZF_DOWNLOADS_DIR="${RCLONEFZF_DOWNLOADS_DIR:-}"
NO_COLOR=${NO_COLOR:-false}

#######################################
# Built-in themes
#######################################
declare -A BUILTIN_THEMES

BUILTIN_THEMES[default]="
fg:#c0caf5
bg:#1a1b26
hl:#7aa2f7
fg+:#c0caf5
bg+:#24283b
hl+:#7dcfff
info:#7aa2f7
prompt:#7dcfff
pointer:#7dcfff
marker:#9ece6a
spinner:#9ece6a
header:#9ece6a
"

BUILTIN_THEMES[light]="
fg:#000000
bg:#ffffff
hl:#005faf
fg+:#000000
bg+:#eaeaea
hl+:#005faf
info:#5f5f5f
prompt:#005faf
pointer:#005faf
marker:#008700
spinner:#008700
header:#008700
"

BUILTIN_THEMES[tokyo-night]="
fg:#C0CAF5
bg:#1A1B26
hl:#FF9E64
fg+:#c0caf5
bg+:#24283b
hl+:#e0af68
info:#7aa2f7
prompt:#bb9af7
pointer:#e0af68
marker:#9ece6a
spinner:#7dcfff
header:#9ece6a
"

BUILTIN_THEMES[neon]="
fg:#E0D0FF
bg:#1A1B26
hl:#FF66FF
fg+:#FFFFFF
bg+:#24283b
hl+:#FF99FF
info:#00FFFF
prompt:#D0A0FF
pointer:#FF00FF
marker:#00FFFF
spinner:#00FFFF
header:#FF99FF
"

#######################################
# Text colors
#######################################

if [[ -n "${NO_COLOR}" && "${NO_COLOR}" != true ]]; then
  export C_RESET='\x1B[0m'
  export C_BOLD='\x1B[1m'
  export C_ITALIC='\x1B[3m'
  export C_UNDERLINE='\x1B[4m'
  export C_BLACK='\x1B[38;5;0m'
  export C_GRAY='\x1B[38;5;245m'
  export C_DARKGRAY='\x1B[38;5;8m'
  export C_WHITE='\x1B[38;5;15m'
  export C_RED='\x1B[38;5;196m'
  export C_GREEN='\x1B[38;5;46m'
  export C_YELLOW='\x1B[38;5;190m'
  export C_BLUE='\x1B[38;5;33m'
  export C_PURPLE='\x1B[38;5;93m'
  export C_MAGENTA='\x1B[38;5;201m'
  export C_CYAN='\x1B[38;5;87m'
  export C_BG_BLACK='\x1B[48;5;0m'
  export C_BG_GRAY='\x1B[48;5;245m'
  export C_BG_DARKGRAY='\x1B[48;5;8m'
  export C_BG_WHITE='\x1B[48;5;15m'
  export C_BG_RED='\x1B[48;5;196m'
  export C_BG_GREEN='\x1B[48;5;46m'
  export C_BG_YELLOW='\x1B[48;5;190m'
  export C_BG_BLUE='\x1B[48;5;33m'
  export C_BG_PURPLE='\x1B[48;5;93m'
  export C_BG_MAGENTA='\x1B[48;5;201m'
  export C_BG_CYAN='\x1B[48;5;87m'
  export C_SAVE_TITLE='\x1B[22;0t'
  export C_RESTORE_TITLE='\x1B[23;0t'
fi

#######################################
# Load config
#######################################
load_config() {
  local cfg
  verbose "Searching for config files ..."
  for cfg in "${CONFIG_PATHS[@]}"; do
    if [[ -f "${cfg}" ]]; then
      verbose "Using config file: '${cfg}' ..."
      # shellcheck disable=SC1090
      source "${cfg}"
      return
    fi
  done
}

#######################################
# Theme resolution
#######################################
resolve_theme() {
  verbose "Loading theme ..."
  # User-defined colors override everything
  if [[ -n "${FZF_COLORS:-}" ]]; then
    return
  fi

  if [[ -n "${BUILTIN_THEMES[${THEME}]:-}" ]]; then
    FZF_COLORS="${BUILTIN_THEMES[${THEME}]}"
    return
  fi

  warn "Unknown theme: '${THEME}', reverting to 'default' theme"
  FZF_COLORS="${BUILTIN_THEMES[default]}"
}

#######################################
# Utilities
#######################################
die() {
  local msg="${1:-Unknown error}"
  printf '%b%s%b%s%b\n' "${C_BG_RED}${C_WHITE}${C_BOLD}" "  ERROR  " "${C_RESET}${C_RED}" " ${msg}" "${C_RESET}" >&2
  exit 1
}
export -f die

warn() {
  local msg="${1:-}"
  [[ -z "${msg}" ]] && return
  printf '%b%s%b%s%b\n' "${C_BG_YELLOW}${C_BLACK}${C_BOLD}" " WARNING " "${C_RESET}${C_YELLOW}" " ${msg}" "${C_RESET}" >&2
}
export -f warn

info() {
  local msg="${1:-}"
  [[ -z "${msg}" ]] && return
  printf '%b%s%b%s%b\n' "${C_BG_BLUE}${C_WHITE}${C_BOLD}" "   INFO  " "${C_RESET}${C_BLUE}" " ${msg}" "${C_RESET}"
}
export -f info

verbose() {
  local msg="${1:-}"
  [[ -z "${msg}" ]] && return
  if [[ -n "${VERBOSE}" && "${VERBOSE}" != false ]]; then
    printf '%b%s%b%s%b\n' "${C_BG_PURPLE}${C_WHITE}${C_BOLD}" " VERBOSE " "${C_RESET}${C_PURPLE}" " ${msg}" "${C_RESET}"
  fi
}
export -f verbose

success() {
  local msg="${1:-}"
  [[ -z "${msg}" ]] && return
  printf '%b%s%b%s%b\n' "${C_BG_GREEN}${C_BLACK}${C_BOLD}" " SUCCESS " "${C_RESET}${C_GREEN}" " ${msg}" "${C_RESET}"
}
export -f success

require_cmd() {
  local cmd
  for cmd in "${@}"; do
    verbose "Checking dependency: ${cmd} ..."
    if command -v "${cmd}" >/dev/null 2>&1; then
      verbose "Found '${cmd}' in PATH ..."
    else
      die "Could not find '${cmd}' in PATH. Make sure it is installed and is in your PATH"
    fi
  done
}

confirm() {
  local prompt="${1:-Are you sure?}"
  local response
  printf '%b%s%b ' "${C_BG_CYAN}${C_BLACK}${C_BOLD}" " CONFIRM " "${C_RESET}"
  printf "${C_BOLD}${C_YELLOW}%s ${C_RESET}${C_BOLD}${C_WHITE}[${C_GREEN}y${C_WHITE}/${C_RED}N${C_WHITE}]: ${C_RESET}" "${prompt}"
  read -r response
  [[ "${response}" =~ ^[Yy]$ ]]
}

draw_line() {
  local WORD LINE
  LINE=''
  COLS="$(tput cols)"
  (( COLS <= 0 )) && COLS="${COLUMNS:-80}"
  for WORD in "${@:-─}"; do
    #shellcheck disable=SC2183
    printf -v LINE '%*s' "${COLS}"
    LINE="${LINE// /${WORD}}"
    echo "${LINE:0:${COLS}}"
  done
}

#######################################
# Help / version
#######################################
show_help() {
  printf "$(cat <<HELPMENU
${C_BLUE}${C_BOLD}NAME${C_RESET}

  ${C_GREEN}${SCRIPT_NAME}${C_RESET}


${C_BLUE}${C_BOLD}DESCRIPTION${C_RESET}

  ${C_WHITE}${SCRIPT_DESCRIPTION}${C_RESET}


${C_BLUE}${C_BOLD}USAGE${C_RESET}

  ${C_GREEN}${SCRIPT_NAME}${C_RESET} ${C_ITALIC}${C_YELLOW}[options]${C_RESET} ${C_ITALIC}${C_PURPLE}[search query]${C_RESET}


${C_BLUE}${C_BOLD}OPTIONS${C_RESET}

  ${C_YELLOW}-k${C_RESET}, ${C_YELLOW}--keybindings${C_RESET}
      ${C_WHITE}Show keybindings${C_RESET}

  ${C_YELLOW}-i${C_RESET}, ${C_YELLOW}--init-config${C_RESET}
      ${C_WHITE}Install example configuration file${C_RESET}

  ${C_YELLOW}-s${C_RESET}, ${C_YELLOW}--show-config${C_RESET}
      ${C_WHITE}Show example configuration file content${C_RESET}

  ${C_YELLOW}-v${C_RESET}, ${C_YELLOW}--verbose${C_RESET}
      ${C_WHITE}Show verbose output${C_RESET}

  ${C_YELLOW}-h${C_RESET}
      ${C_WHITE}Show help${C_RESET}

  ${C_YELLOW}--help${C_RESET}
      ${C_WHITE}Show full help${C_RESET}

  ${C_YELLOW}--help-man${C_RESET}
      ${C_WHITE}Show man page${C_RESET}

  ${C_YELLOW}-V${C_RESET}, ${C_YELLOW}--version${C_RESET}
      ${C_WHITE}Show version${C_RESET}


HELPMENU
  )\n\n"
}

show_examples() {
  printf "$(cat <<EXAMPLESMENU

${C_BLUE}${C_BOLD}EXAMPLES${C_RESET}

  ${C_WHITE}Start ${SCRIPT_NAME} with no options or query${C_RESET}

    ${C_GRAY}\$${C_RESET} ${C_GREEN}${SCRIPT_NAME}${C_RESET}


  ${C_WHITE}Start ${SCRIPT_NAME} with an initial search query of ${C_RESET}${C_PURPLE}'rclone'${C_RESET}

    ${C_GRAY}\$${C_RESET} ${C_GREEN}${SCRIPT_NAME}${C_RESET} ${C_PURPLE}'rclone'${C_RESET}


  ${C_WHITE}Install ${SCRIPT_NAME} configuration file${C_RESET}

    ${C_GRAY}\$${C_RESET} ${C_GREEN}${SCRIPT_NAME}${C_RESET} ${C_YELLOW}--init-config${C_RESET}


  ${C_WHITE}Show ${SCRIPT_NAME} keybindings${C_RESET}

    ${C_GRAY}\$${C_RESET} ${C_GREEN}${SCRIPT_NAME}${C_RESET} ${C_YELLOW}--keybindings${C_RESET}


EXAMPLESMENU
  )\n\n"
}

# TODO: Add more keybindings
#  Ctrl-h              Show help
#  Ctrl-f              Start recursive grep search
show_keybindings() {
  printf "$(cat <<KEYBINDINGSMENU

${C_BLUE}${C_BOLD}KEYBINDINGS${C_RESET}

  ${C_CYAN}NAVIGATION${C_RESET}

    ↑/↓                   - Move up/down
    PGUP                  - Move up one page
    PGDN                  - Move down one page
    HOME                  - Move to first
    END                   - Move to last

  ${C_CYAN}SELECT${C_RESET}

    TAB / Shift-TAB       - Select / Unselect
    CTRL-a                - Select all
    CTRL-d                - Deselect all

  ${C_CYAN}ACTIONS${C_RESET}

    ENTER                 - Perform action on selection
    CTRL-s                - Download selection


  ${C_CYAN}QUERY${C_RESET}

    CTRL-l                - Clear query
    CTRL-Backspace        - Clear query

  ${C_CYAN}LAYOUT${C_RESET}

    CTRL-/                - Change layout
    CTRL-v                - Toggle preview
    ?                     - Show keybindings

  ${C_CYAN}EXIT${C_RESET}

    CTRL-c                - Exit
    CTRL-w                - Exit
    ESC                   - Exit


KEYBINDINGSMENU
  )\n\n\n"
}

show_config_file_paths() {
  printf "$(cat <<CONFIGFILESMENU
${C_BLUE}${C_BOLD}CONFIGURATION FILES${C_RESET} ${C_ITALIC}${C_GRAY}(in order)${C_RESET}

$(printf '  %s\n' "${CONFIG_PATHS[@]}")


CONFIGFILESMENU
  )\n\n\n"
}

show_version() {
  printf '%b%s%b %b%s%b\n' "${C_GREEN}" "${SCRIPT_NAME}" "${C_RESET}" "${C_YELLOW}" "${VERSION}" "${C_RESET}"
}

show_author() {
  printf '%b%s%b %b%s%b\n' "${C_GREEN}" "${SCRIPT_AUTHOR}" "${C_RESET}" "${C_YELLOW}" "${SCRIPT_AUTHOR_URL}" "${C_RESET}"
}

show_help_man() {
  require_cmd man
  man "${SCRIPT_NAME}"
}

show_help_full() {
  draw_line "─"
  show_help
  show_examples
  show_keybindings
  show_config_file_paths
  show_version
  show_author
  draw_line "─"
}

#######################################
# Example config
#######################################

example_config() {

  cat <<EOF
# rclonefzf configuration file (example)
# Override defaults here

# Theme: default, light, tokyo-night, neon
THEME="${THEME:-neon}"

# Preview window options for fzf
PREVIEW_WINDOW="${PREVIEW_WINDOW:-right:60%:wrap}"

# Layout: default, reverse
LAYOUT="${LAYOUT:-reverse}"

# Border style: default, rounded
BORDER="${BORDER:-rounded}"

# Enable preview window
ENABLE_PREVIEW=${ENABLE_PREVIEW:-true}

# Verbose output
VERBOSE=${VERBOSE:-false}

# Pager (less, bat, etc.)
RCLONEFZF_PAGER="${PAGER:-less}"

# Close rclonefzf with 'ctrl-c' keypress
CTRL_C_CLOSE=${CTRL_C_CLOSE:-true}

# rclone max depth, how deep to view down tree
RCLONE_MAX_DEPTH=${RCLONE_MAX_DEPTH:-10}

# Directory to save downloaded files to (uncomment or leave blank to use '\${PWD}')
RCLONEFZF_DOWNLOADS_DIR="${RCLONEFZF_DOWNLOADS_DIR:-${HOME}/Downloads/rclonefzf}"

# Do not use color for output
NO_COLOR=${NO_COLOR:-false}


#vim:filetype=conf:shiftwidth=2:softtabstop=2:expandtab
EOF
}

install_example_config() {
  local cfg_file="${XDG_CONFIG_DIR}/rclonefzf.conf"

  mkdir -p "$(dirname "${cfg_file}")"
  if [[ -f "${cfg_file}" ]]; then
    warn "Configuration file already exists: '${cfg_file}', skipping creation."
    return
  fi

  example_config > "${cfg_file}"
  success "Created configuration file: '${cfg_file}'"
}

show_config_file_contents() {
  local cfg_file="${XDG_CONFIG_DIR}/rclonefzf.conf"
  if [[ -f "${cfg_file}" ]]; then
    "${RCLONEFZF_PAGER}" "${cfg_file}"
  else
    example_config
  fi
  printf "\n\n# Configuration file locations:\n"
  printf '#\t%s\n' "${CONFIG_PATHS[@]}"
}

# Ensure download directory exists and is usable
ensure_download_dir() {
  local dir_to_use

  if [[ -z "${RCLONEFZF_DOWNLOADS_DIR:-}" ]]; then
    # Not set → fallback to current directory
    dir_to_use="${PWD}"
    verbose "'RCLONEFZF_DOWNLOADS_DIR' not set, using current directory: '${dir_to_use}'"
  else
    dir_to_use="${RCLONEFZF_DOWNLOADS_DIR}"

    # Try to create it if it doesn't exist
    if [[ ! -d "${dir_to_use}" ]]; then
      if mkdir -p "${dir_to_use}" 2>/dev/null; then
        success "Created download directory: ${dir_to_use}"
      else
        warn "Cannot create directory '${dir_to_use}' (permission denied?), Falling back to ${PWD}"
        dir_to_use="${PWD}"
      fi
    fi

    # Final writability check
    if [[ ! -w "${dir_to_use}" ]]; then
      warn "Directory '${dir_to_use}' is not writable, falling back to ${PWD}"
      dir_to_use="${PWD}"
    fi
  fi

  # Export the final value so the rest of the script uses it
  RCLONEFZF_DOWNLOADS_DIR="${dir_to_use%/}/"
  export RCLONEFZF_DOWNLOADS_DIR

  verbose "Final download directory: '${RCLONEFZF_DOWNLOADS_DIR}'"
}

rclonefzf_copy_selected() {
  local line file
  local remote="${RCLONE_REMOTE:?RCLONE_REMOTE not set}"
  local dest="${RCLONEFZF_DOWNLOADS_DIR:?Download dir not set}"

  # Read stdin (all selected files)
  while IFS= read -r line; do
    [[ -z "${line}" ]] && continue

    # Use eval to respect quotes in input line
    # TODO: Do not use 'eval'
    local files
    eval "files=(${line})"

    info "Starting file download ..."

    for file in "${files[@]}"; do
      # Remove any remaining leading/trailing single quotes (if needed)
      file="${file#\'}"
      file="${file%\'}"

      # Skip empty filenames
      [[ -z "${file}" ]] && continue

      verbose "Downloading file: '${remote}:${file}' → '${dest}${file}' ..."
      if rclone copy "${remote}:${file}" "${dest}" "${RCLONE_COPY_OPTIONS[@]}"; then
        verbose "Downloaded file: '${remote}:${file}' → '${dest}${file}'"
      else
        warn "Unable to download file: '${remote}:${file}'"
      fi
    done
  done
}
export -f rclonefzf_copy_selected

#######################################
# Command line argument parsing
#######################################
SEARCH_QUERY=""
CONFIG_INIT=false
if [[ -n "${VERBOSE}" && "${VERBOSE}" != false ]]; then
  export VERBOSE
fi

while [[ $# -gt 0 ]]; do
  case "${1}" in
    -k|--key*)    show_keybindings;                           exit 0 ;;
    -i|--init-c*) CONFIG_INIT=true;                           shift  ;;
    -s|--show-c*) show_config_file_contents;                  exit 0 ;;
    -v|--verb*)   export VERBOSE=true;                        shift  ;;
    -h)           show_help;                                  exit 0 ;;
    --help)       show_help_full;                             exit 0 ;;
    --help-man)   show_help_man;                              exit 0 ;;
    -V|--vers*)   show_version;                               exit 0 ;;
    -*)           die "Unknown option: '${1}'. See help for options" ;;
    *)            SEARCH_QUERY+="${SEARCH_QUERY:+ }${1}";     shift  ;;
  esac
done

#######################################
# Init
#######################################
declare -a RCLONE_REMOTES=()
load_config
resolve_theme
require_cmd rclone fzf
ensure_download_dir

if [[ "${CONFIG_INIT}" == true ]]; then
  install_example_config
  exit 0
fi

#######################################
# Build fzf options
#######################################
FZF_OPTS=(
  --ansi
  --bind="?:preview(echo '$(show_keybindings)')"
  --bind='ctrl-w:abort'
  --bind='end:last'
  --bind='esc:abort'
  --bind='home:first'
  --bind='pgdn:page-down'
  --bind='pgup:page-up'
  --border="${BORDER}"
  --color="$(printf '%s' "${FZF_COLORS}" | tr '\n' ',' | sed 's/,$//')"
  --delimiter=' '
  --ellipsis='⣿'
  --header='Press ? for keybindings'
  --info=inline
  --layout="${LAYOUT}"
  --multi
  --cycle
  --tiebreak=begin
)
if [[ -n "${ENABLE_PREVIEW}" && "${ENABLE_PREVIEW}" != false ]]; then
  FZF_OPTS+=( --preview-window="${PREVIEW_WINDOW}" )
fi
readonly FZF_OPTS


# shellcheck disable=SC2089
FZF_BIND_COPY='ctrl-s:execute(bash -c "rclonefzf_copy_selected" <<< "{+}")+abort'
# shellcheck disable=SC2090
export FZF_BIND_COPY

# NOTE: These bind options are not for the main menu. If you want to add bindings to main menu,
# Please configure bindings in 'FZF_OPTS'
FZF_BIND_OPTIONS=(
  --bind='ctrl-/:change-preview-window(up,border-rounded|up,40%,border-rounded|left,border-rounded|left,border-rounded,40%|down,border-rounded|down,40%,border-rounded|down,10%,border-rounded|hidden|right,40%,border-rounded|right,70%,border-rounded|right,90%,border-rounded)'
  --bind='ctrl-l:clear-query+clear-screen+clear-selection'
  --bind='ctrl-a:select-all'
  --bind='ctrl-d:deselect-all'
  --bind='ctrl-bspace:clear-query'
  --bind='ctrl-v:toggle-preview'
  --bind="${FZF_BIND_COPY}"
)
readonly FZF_BIND_OPTIONS

#######################################
# Build rclone options
#######################################
RCLONE_LSF_OPTIONS=(
  --recursive
  --max-depth="${RCLONE_MAX_DEPTH}"
  --fast-list
  --files-only
)

RCLONE_CAT_OPTIONS=(
  --max-depth="${RCLONE_MAX_DEPTH}"
)

RCLONE_COPY_OPTIONS=(
  --check-first
  --metadata
  --progress
)

if [[ -n "${VERBOSE}" && "${VERBOSE}" != false ]]; then
  RCLONE_COPY_OPTIONS+=( --verbose)
fi

readonly RCLONE_LSF_OPTIONS
readonly RCLONE_CAT_OPTIONS
readonly RCLONE_COPY_OPTIONS

#######################################
# Core actions
#######################################

# Populates global RCLONE_REMOTES array
list_remotes() {
  # Return if RCLONE_REMOTES already has entries
  (( ${#RCLONE_REMOTES[@]} > 0 )) && return 0

  local -a remotes

  if ! mapfile -t remotes < <(rclone listremotes); then
    die "Failed to list rclone remotes"
  fi

  (( ${#remotes[@]} > 0 )) || die "No remotes found. Please configure rclone: 'rclone config'"

  # Strip trailing ':' from each remote
  local i
  for i in "${!remotes[@]}"; do
    remotes[i]="${remotes[i]%:}"
  done

  RCLONE_REMOTES=(
    "${remotes[@]}"
    "Install config"
    "Show config"
    "Keybindings"
    "Help"
    "Exit"
  )
}

file_viewer() {
  local rclone_remote file_viewer_prompt selection selection_arr
  rclone_remote="${1}"
  file_viewer_prompt="Remote: '${rclone_remote}': "

  #shellcheck disable=2145
  selection=$(
    rclone lsf "${RCLONE_LSF_OPTIONS[@]}" "${rclone_remote}:" 2> /dev/null |
      fzf "${FZF_OPTS[@]}" "${FZF_BIND_OPTIONS[@]}" \
        --query "${SEARCH_QUERY:-}"      \
        --prompt "${file_viewer_prompt}" \
        --preview "rclone cat \"${RCLONE_CAT_OPTIONS[@]}\" '${rclone_remote}:{r}' 2>/dev/null" || true
  )

  if [[ -z "${selection}" ]]; then
    verbose "No files selected."
    return
  fi

  mapfile -t selection_arr <<< "${selection}"
  #shellcheck disable=2145
  printf '%s\n' "${selection_arr[@]}" |
    fzf "${FZF_OPTS[@]}" "${FZF_BIND_OPTIONS[@]}" \
      --prompt "${file_viewer_prompt} Selected Files: " \
      --preview "rclone cat \"${RCLONE_CAT_OPTIONS[@]}\" '${rclone_remote}:{r}' 2>/dev/null" || true
}

#######################################
# Main menu
#######################################
main_menu() {
  local main_menu_prompt
  main_menu_prompt="Select rclone remote or option :> "
  list_remotes
  printf '%s\n' "${RCLONE_REMOTES[@]}" | fzf "${FZF_OPTS[@]}" --prompt="${main_menu_prompt}"
}

#######################################
# Main loop
#######################################
main() {
  while true; do
    local choice
    choice="$(main_menu || true)"
    if [[ -n "${CTRL_C_CLOSE}" && "${CTRL_C_CLOSE}" != true ]]; then
      [[ -z "${choice}" ]] && continue
    fi

    case "${choice}" in
      "Install config")
        install_example_config
        exit 0
        ;;
      "Show config")
        show_config_file_contents
        exit 0
        ;;
      "Keybindings")
        show_keybindings
        exit 0
        ;;
      "Help")
        show_help_full
        exit 0
        ;;
      "Exit"|"")
        exit 0
        ;;
      *)
        RCLONE_REMOTE="${choice}"
        export RCLONE_REMOTE
        file_viewer "${RCLONE_REMOTE}"
        ;;
    esac
  done
}

main
